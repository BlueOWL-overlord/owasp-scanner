<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX v3 installer for OWASP Dependency Scanner — fully self-contained.
  Bundles: Python backend (PyInstaller), React UI, Eclipse Temurin JRE 21,
           and OWASP Dependency Check.

  Built by build-msi.ps1 — do NOT run WiX tools manually.
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Product Id="*"
           Name="OWASP Dependency Scanner"
           Language="1033"
           Version="$(var.Version)"
           Manufacturer="OWASP Scanner Project"
           UpgradeCode="6E8B3C1A-4D27-4F9E-B2A5-3C7E9F8D0B1E">

    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Description="OWASP Dependency Scanner — standalone installer"
             Comments="Fully self-contained. No prerequisites required." />

    <!-- ================================================================== -->
    <!-- Upgrade handling                                                     -->
    <!-- ================================================================== -->
    <MajorUpgrade
        Schedule="afterInstallInitialize"
        DowngradeErrorMessage="A newer version of OWASP Dependency Scanner is already installed." />

    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- ================================================================== -->
    <!-- Properties                                                           -->
    <!-- ================================================================== -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- No Java prerequisite — JRE is bundled inside the MSI -->

    <!-- ================================================================== -->
    <!-- Directory structure                                                  -->
    <!-- ================================================================== -->
    <Directory Id="TARGETDIR" Name="SourceDir">

      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="OWASP Scanner">
          <!-- JRE sub-directory -->
          <Directory Id="JRE_FOLDER" Name="jre" />
          <!-- OWASP DC sub-directory -->
          <Directory Id="OWASPDC_FOLDER" Name="dependency-check" />
        </Directory>
      </Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="OWASP Scanner" />
      </Directory>

      <Directory Id="DesktopFolder" Name="Desktop" />

    </Directory>

    <!-- ================================================================== -->
    <!-- Features                                                             -->
    <!-- ================================================================== -->
    <Feature Id="AppFeature"
             Title="OWASP Dependency Scanner"
             Description="Backend + frontend web application."
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAdvertise="no"
             InstallDefault="local">
      <ComponentGroupRef Id="AppFileComponents" />
      <ComponentRef Id="ShortcutsComponent" />
    </Feature>

    <Feature Id="JREFeature"
             Title="Java Runtime (bundled)"
             Description="Eclipse Temurin JRE 21 LTS — required by OWASP Dependency Check."
             Level="1"
             AllowAdvertise="no"
             InstallDefault="local">
      <ComponentGroupRef Id="JREComponents" />
    </Feature>

    <Feature Id="OWASPDCFeature"
             Title="OWASP Dependency Check"
             Description="The OWASP DC scanner tool."
             Level="1"
             AllowAdvertise="no"
             InstallDefault="local">
      <ComponentGroupRef Id="OWASPDCComponents" />
    </Feature>

    <!-- ================================================================== -->
    <!-- Shortcuts                                                            -->
    <!-- ================================================================== -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ShortcutsComponent"
                 Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">

        <Shortcut Id="StartMenuShortcut"
                  Name="OWASP Dependency Scanner"
                  Description="Launch the OWASP Dependency Scanner (opens browser)"
                  Target="[INSTALLFOLDER]owasp-scanner.exe"
                  WorkingDirectory="INSTALLFOLDER" />

        <Shortcut Id="DesktopShortcut"
                  Directory="DesktopFolder"
                  Name="OWASP Dependency Scanner"
                  Description="Launch the OWASP Dependency Scanner (opens browser)"
                  Target="[INSTALLFOLDER]owasp-scanner.exe"
                  WorkingDirectory="INSTALLFOLDER" />

        <Shortcut Id="UninstallShortcut"
                  Name="Uninstall OWASP Dependency Scanner"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />

        <RemoveFolder Id="CleanUpShortcutFolder"
                      Directory="ApplicationProgramsFolder"
                      On="uninstall" />

        <RegistryValue Root="HKCU"
                       Key="Software\OWASPScanner"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- ================================================================== -->
    <!-- UI                                                                   -->
    <!-- ================================================================== -->
    <UIRef Id="WixUI_InstallDir" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- ================================================================== -->
    <!-- Post-install: launch the application                                 -->
    <!-- ================================================================== -->
    <CustomAction Id="LaunchApp"
                  Directory="INSTALLFOLDER"
                  ExeCommand="&quot;[INSTALLFOLDER]owasp-scanner.exe&quot;"
                  Return="asyncNoWait"
                  Impersonate="yes" />

    <InstallExecuteSequence>
      <Custom Action="LaunchApp" After="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
